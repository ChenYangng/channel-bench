/*
 * Copyright 2014, NICTA
 *
 * This software may be distributed and modified according to the terms of
 * the BSD 2-Clause license. Note that NO WARRANTY is provided.
 * See "LICENSE_BSD2.txt" for details.
 *
 * @TAG(NICTA_BSD)
 */

/*page size*/
#define BENCH_PAGE_SIZE    0x1000 

/*cache line size*/
#define CL_SIZE    64 

/*The prime buffer for the icache attack*/


#define ICACHE_PBUFFER   \
.global icache_pbuffer;                        \
.type icache_pbuffer, %function;               \
.align CL_SIZE; \
icache_pbuffer:                                \
    jmp   .+BENCH_PAGE_SIZE; /*jump to next ith line in next page*/    \
.size icache_pbuffer, .-icache_pbuffer;


#define LINE_JUMP(number)    \
.global line_jump_##number;                        \
.type line_jump_##number, %function;               \
.align CL_SIZE; \
line_jump_##number:                                \
    jmp   .+BENCH_PAGE_SIZE; /*jump to next ith line in next page*/    \
.size line_jump_##number, .-line_jump_##number;

#define PROBE_RETURN(number)    \
.global probe_return_##number;                        \
.type probe_return_##number, %function;               \
.align CL_SIZE;   \
probe_return_##number:                                \
    ret; \
.size probe_return_##number, .-probe_return_##number;


/*prime buffer for L1 cache, 64 sets, 8 ways, a cache line per jump*/
.section .data 
    ICACHE_PBUFFER
    LINE_JUMP(1)
    LINE_JUMP(2)
    LINE_JUMP(3)
    LINE_JUMP(4)
    LINE_JUMP(5)
    LINE_JUMP(6)
    LINE_JUMP(7)
    LINE_JUMP(8)
    LINE_JUMP(9)
    LINE_JUMP(10)
    LINE_JUMP(11)
    LINE_JUMP(12)
    LINE_JUMP(13)
    LINE_JUMP(14)
    LINE_JUMP(15)
    LINE_JUMP(16)
    LINE_JUMP(17)
    LINE_JUMP(18)
    LINE_JUMP(19)
    LINE_JUMP(20)
    LINE_JUMP(21)
    LINE_JUMP(22)
    LINE_JUMP(23)
    LINE_JUMP(24)
    LINE_JUMP(25)
    LINE_JUMP(26)
    LINE_JUMP(27)
    LINE_JUMP(28)
    LINE_JUMP(29)
    LINE_JUMP(30)
    LINE_JUMP(31)
    LINE_JUMP(32)
    LINE_JUMP(33)
    LINE_JUMP(34)
    LINE_JUMP(35)
    LINE_JUMP(36)
    LINE_JUMP(37)
    LINE_JUMP(38)
    LINE_JUMP(39)
    LINE_JUMP(40)
    LINE_JUMP(41)
    LINE_JUMP(42)
    LINE_JUMP(43)
    LINE_JUMP(44)
    LINE_JUMP(45)
    LINE_JUMP(46)
    LINE_JUMP(47)
    LINE_JUMP(48)
    LINE_JUMP(49)
    LINE_JUMP(50)
    LINE_JUMP(51)
    LINE_JUMP(52)
    LINE_JUMP(53)
    LINE_JUMP(54)
    LINE_JUMP(55)
    LINE_JUMP(56)
    LINE_JUMP(57)
    LINE_JUMP(58)
    LINE_JUMP(59)
    LINE_JUMP(60)
    LINE_JUMP(61)
    LINE_JUMP(62)
    LINE_JUMP(63)
    LINE_JUMP(64)
    LINE_JUMP(65)
    LINE_JUMP(66)
    LINE_JUMP(67)
    LINE_JUMP(68)
    LINE_JUMP(69)
    LINE_JUMP(70)
    LINE_JUMP(71)
    LINE_JUMP(72)
    LINE_JUMP(73)
    LINE_JUMP(74)
    LINE_JUMP(75)
    LINE_JUMP(76)
    LINE_JUMP(77)
    LINE_JUMP(78)
    LINE_JUMP(79)
    LINE_JUMP(80)
    LINE_JUMP(81)
    LINE_JUMP(82)
    LINE_JUMP(83)
    LINE_JUMP(84)
    LINE_JUMP(85)
    LINE_JUMP(86)
    LINE_JUMP(87)
    LINE_JUMP(88)
    LINE_JUMP(89)
    LINE_JUMP(90)
    LINE_JUMP(91)
    LINE_JUMP(92)
    LINE_JUMP(93)
    LINE_JUMP(94)
    LINE_JUMP(95)
    LINE_JUMP(96)
    LINE_JUMP(97)
    LINE_JUMP(98)
    LINE_JUMP(99)
    LINE_JUMP(100)
    LINE_JUMP(101)
    LINE_JUMP(102)
    LINE_JUMP(103)
    LINE_JUMP(104)
    LINE_JUMP(105)
    LINE_JUMP(106)
    LINE_JUMP(107)
    LINE_JUMP(108)
    LINE_JUMP(109)
    LINE_JUMP(110)
    LINE_JUMP(111)
    LINE_JUMP(112)
    LINE_JUMP(113)
    LINE_JUMP(114)
    LINE_JUMP(115)
    LINE_JUMP(116)
    LINE_JUMP(117)
    LINE_JUMP(118)
    LINE_JUMP(119)
    LINE_JUMP(120)
    LINE_JUMP(121)
    LINE_JUMP(122)
    LINE_JUMP(123)
    LINE_JUMP(124)
    LINE_JUMP(125)
    LINE_JUMP(126)
    LINE_JUMP(127)
    LINE_JUMP(128)
    LINE_JUMP(129)
    LINE_JUMP(130)
    LINE_JUMP(131)
    LINE_JUMP(132)
    LINE_JUMP(133)
    LINE_JUMP(134)
    LINE_JUMP(135)
    LINE_JUMP(136)
    LINE_JUMP(137)
    LINE_JUMP(138)
    LINE_JUMP(139)
    LINE_JUMP(140)
    LINE_JUMP(141)
    LINE_JUMP(142)
    LINE_JUMP(143)
    LINE_JUMP(144)
    LINE_JUMP(145)
    LINE_JUMP(146)
    LINE_JUMP(147)
    LINE_JUMP(148)
    LINE_JUMP(149)
    LINE_JUMP(150)
    LINE_JUMP(151)
    LINE_JUMP(152)
    LINE_JUMP(153)
    LINE_JUMP(154)
    LINE_JUMP(155)
    LINE_JUMP(156)
    LINE_JUMP(157)
    LINE_JUMP(158)
    LINE_JUMP(159)
    LINE_JUMP(160)
    LINE_JUMP(161)
    LINE_JUMP(162)
    LINE_JUMP(163)
    LINE_JUMP(164)
    LINE_JUMP(165)
    LINE_JUMP(166)
    LINE_JUMP(167)
    LINE_JUMP(168)
    LINE_JUMP(169)
    LINE_JUMP(170)
    LINE_JUMP(171)
    LINE_JUMP(172)
    LINE_JUMP(173)
    LINE_JUMP(174)
    LINE_JUMP(175)
    LINE_JUMP(176)
    LINE_JUMP(177)
    LINE_JUMP(178)
    LINE_JUMP(179)
    LINE_JUMP(180)
    LINE_JUMP(181)
    LINE_JUMP(182)
    LINE_JUMP(183)
    LINE_JUMP(184)
    LINE_JUMP(185)
    LINE_JUMP(186)
    LINE_JUMP(187)
    LINE_JUMP(188)
    LINE_JUMP(189)
    LINE_JUMP(190)
    LINE_JUMP(191)
    LINE_JUMP(192)
    LINE_JUMP(193)
    LINE_JUMP(194)
    LINE_JUMP(195)
    LINE_JUMP(196)
    LINE_JUMP(197)
    LINE_JUMP(198)
    LINE_JUMP(199)
    LINE_JUMP(200)
    LINE_JUMP(201)
    LINE_JUMP(202)
    LINE_JUMP(203)
    LINE_JUMP(204)
    LINE_JUMP(205)
    LINE_JUMP(206)
    LINE_JUMP(207)
    LINE_JUMP(208)
    LINE_JUMP(209)
    LINE_JUMP(210)
    LINE_JUMP(211)
    LINE_JUMP(212)
    LINE_JUMP(213)
    LINE_JUMP(214)
    LINE_JUMP(215)
    LINE_JUMP(216)
    LINE_JUMP(217)
    LINE_JUMP(218)
    LINE_JUMP(219)
    LINE_JUMP(220)
    LINE_JUMP(221)
    LINE_JUMP(222)
    LINE_JUMP(223)
    LINE_JUMP(224)
    LINE_JUMP(225)
    LINE_JUMP(226)
    LINE_JUMP(227)
    LINE_JUMP(228)
    LINE_JUMP(229)
    LINE_JUMP(230)
    LINE_JUMP(231)
    LINE_JUMP(232)
    LINE_JUMP(233)
    LINE_JUMP(234)
    LINE_JUMP(235)
    LINE_JUMP(236)
    LINE_JUMP(237)
    LINE_JUMP(238)
    LINE_JUMP(239)
    LINE_JUMP(240)
    LINE_JUMP(241)
    LINE_JUMP(242)
    LINE_JUMP(243)
    LINE_JUMP(244)
    LINE_JUMP(245)
    LINE_JUMP(246)
    LINE_JUMP(247)
    LINE_JUMP(248)
    LINE_JUMP(249)
    LINE_JUMP(250)
    LINE_JUMP(251)
    LINE_JUMP(252)
    LINE_JUMP(253)
    LINE_JUMP(254)
    LINE_JUMP(255)
    LINE_JUMP(256)
    LINE_JUMP(257)
    LINE_JUMP(258)
    LINE_JUMP(259)
    LINE_JUMP(260)
    LINE_JUMP(261)
    LINE_JUMP(262)
    LINE_JUMP(263)
    LINE_JUMP(264)
    LINE_JUMP(265)
    LINE_JUMP(266)
    LINE_JUMP(267)
    LINE_JUMP(268)
    LINE_JUMP(269)
    LINE_JUMP(270)
    LINE_JUMP(271)
    LINE_JUMP(272)
    LINE_JUMP(273)
    LINE_JUMP(274)
    LINE_JUMP(275)
    LINE_JUMP(276)
    LINE_JUMP(277)
    LINE_JUMP(278)
    LINE_JUMP(279)
    LINE_JUMP(280)
    LINE_JUMP(281)
    LINE_JUMP(282)
    LINE_JUMP(283)
    LINE_JUMP(284)
    LINE_JUMP(285)
    LINE_JUMP(286)
    LINE_JUMP(287)
    LINE_JUMP(288)
    LINE_JUMP(289)
    LINE_JUMP(290)
    LINE_JUMP(291)
    LINE_JUMP(292)
    LINE_JUMP(293)
    LINE_JUMP(294)
    LINE_JUMP(295)
    LINE_JUMP(296)
    LINE_JUMP(297)
    LINE_JUMP(298)
    LINE_JUMP(299)
    LINE_JUMP(300)
    LINE_JUMP(301)
    LINE_JUMP(302)
    LINE_JUMP(303)
    LINE_JUMP(304)
    LINE_JUMP(305)
    LINE_JUMP(306)
    LINE_JUMP(307)
    LINE_JUMP(308)
    LINE_JUMP(309)
    LINE_JUMP(310)
    LINE_JUMP(311)
    LINE_JUMP(312)
    LINE_JUMP(313)
    LINE_JUMP(314)
    LINE_JUMP(315)
    LINE_JUMP(316)
    LINE_JUMP(317)
    LINE_JUMP(318)
    LINE_JUMP(319)
    LINE_JUMP(320)
    LINE_JUMP(321)
    LINE_JUMP(322)
    LINE_JUMP(323)
    LINE_JUMP(324)
    LINE_JUMP(325)
    LINE_JUMP(326)
    LINE_JUMP(327)
    LINE_JUMP(328)
    LINE_JUMP(329)
    LINE_JUMP(330)
    LINE_JUMP(331)
    LINE_JUMP(332)
    LINE_JUMP(333)
    LINE_JUMP(334)
    LINE_JUMP(335)
    LINE_JUMP(336)
    LINE_JUMP(337)
    LINE_JUMP(338)
    LINE_JUMP(339)
    LINE_JUMP(340)
    LINE_JUMP(341)
    LINE_JUMP(342)
    LINE_JUMP(343)
    LINE_JUMP(344)
    LINE_JUMP(345)
    LINE_JUMP(346)
    LINE_JUMP(347)
    LINE_JUMP(348)
    LINE_JUMP(349)
    LINE_JUMP(350)
    LINE_JUMP(351)
    LINE_JUMP(352)
    LINE_JUMP(353)
    LINE_JUMP(354)
    LINE_JUMP(355)
    LINE_JUMP(356)
    LINE_JUMP(357)
    LINE_JUMP(358)
    LINE_JUMP(359)
    LINE_JUMP(360)
    LINE_JUMP(361)
    LINE_JUMP(362)
    LINE_JUMP(363)
    LINE_JUMP(364)
    LINE_JUMP(365)
    LINE_JUMP(366)
    LINE_JUMP(367)
    LINE_JUMP(368)
    LINE_JUMP(369)
    LINE_JUMP(370)
    LINE_JUMP(371)
    LINE_JUMP(372)
    LINE_JUMP(373)
    LINE_JUMP(374)
    LINE_JUMP(375)
    LINE_JUMP(376)
    LINE_JUMP(377)
    LINE_JUMP(378)
    LINE_JUMP(379)
    LINE_JUMP(380)
    LINE_JUMP(381)
    LINE_JUMP(382)
    LINE_JUMP(383)
    LINE_JUMP(384)
    LINE_JUMP(385)
    LINE_JUMP(386)
    LINE_JUMP(387)
    LINE_JUMP(388)
    LINE_JUMP(389)
    LINE_JUMP(390)
    LINE_JUMP(391)
    LINE_JUMP(392)
    LINE_JUMP(393)
    LINE_JUMP(394)
    LINE_JUMP(395)
    LINE_JUMP(396)
    LINE_JUMP(397)
    LINE_JUMP(398)
    LINE_JUMP(399)
    LINE_JUMP(400)
    LINE_JUMP(401)
    LINE_JUMP(402)
    LINE_JUMP(403)
    LINE_JUMP(404)
    LINE_JUMP(405)
    LINE_JUMP(406)
    LINE_JUMP(407)
    LINE_JUMP(408)
    LINE_JUMP(409)
    LINE_JUMP(410)
    LINE_JUMP(411)
    LINE_JUMP(412)
    LINE_JUMP(413)
    LINE_JUMP(414)
    LINE_JUMP(415)
    LINE_JUMP(416)
    LINE_JUMP(417)
    LINE_JUMP(418)
    LINE_JUMP(419)
    LINE_JUMP(420)
    LINE_JUMP(421)
    LINE_JUMP(422)
    LINE_JUMP(423)
    LINE_JUMP(424)
    LINE_JUMP(425)
    LINE_JUMP(426)
    LINE_JUMP(427)
    LINE_JUMP(428)
    LINE_JUMP(429)
    LINE_JUMP(430)
    LINE_JUMP(431)
    LINE_JUMP(432)
    LINE_JUMP(433)
    LINE_JUMP(434)
    LINE_JUMP(435)
    LINE_JUMP(436)
    LINE_JUMP(437)
    LINE_JUMP(438)
    LINE_JUMP(439)
    LINE_JUMP(440)
    LINE_JUMP(441)
    LINE_JUMP(442)
    LINE_JUMP(443)
    LINE_JUMP(444)
    LINE_JUMP(445)
    LINE_JUMP(446)
    LINE_JUMP(447)  /*7 ways*/
    PROBE_RETURN(0)
    PROBE_RETURN(1)
    PROBE_RETURN(2)
    PROBE_RETURN(3)
    PROBE_RETURN(4)
    PROBE_RETURN(5)
    PROBE_RETURN(6)
    PROBE_RETURN(7)
    PROBE_RETURN(8)
    PROBE_RETURN(9)
    PROBE_RETURN(10)
    PROBE_RETURN(11)
    PROBE_RETURN(12)
    PROBE_RETURN(13)
    PROBE_RETURN(14)
    PROBE_RETURN(15)
    PROBE_RETURN(16)
    PROBE_RETURN(17)
    PROBE_RETURN(18)
    PROBE_RETURN(19)
    PROBE_RETURN(20)
    PROBE_RETURN(21)
    PROBE_RETURN(22)
    PROBE_RETURN(23)
    PROBE_RETURN(24)
    PROBE_RETURN(25)
    PROBE_RETURN(26)
    PROBE_RETURN(27)
    PROBE_RETURN(28)
    PROBE_RETURN(29)
    PROBE_RETURN(30)
    PROBE_RETURN(31)
    PROBE_RETURN(32)
    PROBE_RETURN(33)
    PROBE_RETURN(34)
    PROBE_RETURN(35)
    PROBE_RETURN(36)
    PROBE_RETURN(37)
    PROBE_RETURN(38)
    PROBE_RETURN(39)
    PROBE_RETURN(40)
    PROBE_RETURN(41)
    PROBE_RETURN(42)
    PROBE_RETURN(43)
    PROBE_RETURN(44)
    PROBE_RETURN(45)
    PROBE_RETURN(46)
    PROBE_RETURN(47)
    PROBE_RETURN(48)
    PROBE_RETURN(49)
    PROBE_RETURN(50)
    PROBE_RETURN(51)
    PROBE_RETURN(52)
    PROBE_RETURN(53)
    PROBE_RETURN(54)
    PROBE_RETURN(55)
    PROBE_RETURN(56)
    PROBE_RETURN(57)
    PROBE_RETURN(58)
    PROBE_RETURN(59)
    PROBE_RETURN(60)
    PROBE_RETURN(61)
    PROBE_RETURN(62)
PROBE_RETURN(63)
